<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AllerGUARD ‚Äì AI Ingredient Scanner</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=IBM+Plex+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
    --primary:#6366f1;
    --danger:#ef4444;
    --success:#10b981;
    --bg:#f8fafc;
    --card:#ffffff;
    --border:#e2e8f0;
    --text:#1e293b;
    --sub:#64748b;
    --radius:14px;
}

*{margin:0;padding:0;box-sizing:border-box;}

body{
    font-family:'Inter','IBM Plex Sans Thai',sans-serif;
    background:var(--bg);
    color:var(--text);
    height:100vh;
    overflow:hidden;
}

/* Layout */
.app{
    display:grid;
    grid-template-columns:380px 1fr;
    height:100vh;
}

/* Sidebar */
.sidebar{
    background:var(--card);
    border-right:1px solid var(--border);
    padding:2rem;
    display:flex;
    flex-direction:column;
    gap:1.5rem;
    overflow-y:auto;
}

.brand h1{
    font-size:1.4rem;
    color:var(--primary);
    font-weight:800;
}

.upload{
    border:2px dashed var(--border);
    border-radius:var(--radius);
    padding:2rem;
    text-align:center;
    cursor:pointer;
    transition:.3s;
}

.upload:hover{
    border-color:var(--primary);
    background:#f5f7ff;
}

.preview-img{
    width:100%;
    height:200px;
    object-fit:cover;
    border-radius:var(--radius);
}

input[type="text"]{
    width:100%;
    padding:.75rem 1rem;
    border:1px solid var(--border);
    border-radius:var(--radius);
    outline:none;
}

button.primary{
    background:var(--primary);
    color:white;
    border:none;
    padding:1rem;
    border-radius:var(--radius);
    font-weight:700;
    cursor:pointer;
}

button.primary:disabled{
    opacity:.6;
    cursor:not-allowed;
}

/* Main */
.main{
    padding:3rem;
    overflow-y:auto;
    position:relative;
}

.empty{
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    color:var(--sub);
}

/* Results */
.results{
    max-width:900px;
    margin:auto;
    display:none;
}

.results.active{display:block;}

.banner{
    padding:1.5rem;
    border-radius:var(--radius);
    margin-bottom:2rem;
    display:flex;
    align-items:center;
    gap:1rem;
}

.banner.safe{
    background:#ecfdf5;
    border:1px solid #a7f3d0;
    color:var(--success);
}

.banner.danger{
    background:#fef2f2;
    border:1px solid #fecaca;
    color:var(--danger);
}

.section-title{
    font-weight:700;
    margin-bottom:1rem;
}

.ingredients-dropdown{
    background:white;
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:1rem;
    margin-bottom:2rem;
}

.ingredients-dropdown summary{
    cursor:pointer;
    font-weight:600;
}

.tag{
    display:inline-block;
    background:#f1f5f9;
    padding:.4rem .8rem;
    margin:.3rem;
    border-radius:20px;
    font-size:.8rem;
}

/* Risk Cards */
.risk-grid{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:1rem;
    margin-bottom:2rem;
}

.risk-card{
    background:#fef2f2;
    border:1px solid #fecaca;
    padding:1.5rem;
    border-radius:var(--radius);
    text-align:center;
    font-weight:700;
    color:var(--danger);
}

/* Loading */
.loader{
    position:absolute;
    inset:0;
    background:rgba(255,255,255,.8);
    display:none;
    align-items:center;
    justify-content:center;
    font-weight:600;
}

@media(max-width:900px){
    .app{grid-template-columns:1fr;height:auto;}
}
</style>
</head>
<body>

<div class="app">

<aside class="sidebar">
    <div class="brand">
        <h1>üõ°Ô∏è AllerGUARD</h1>
    </div>

    <div class="upload" id="dropZone">
        üì∏ Upload Label
    </div>

    <input type="file" id="fileInput" hidden accept="image/*">

    <div>
        <label>üö® Your Allergies</label>
        <input type="text" id="allergyInput" placeholder="e.g. sodium, dimethicone">
    </div>

    <button class="primary" id="analyzeBtn">üîç Scan Ingredients</button>
</aside>

<main class="main">

<div class="loader" id="loader">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...</div>

<div class="empty" id="emptyState">
    <h2>Upload image to start</h2>
</div>

<div class="results" id="results">

    <div id="statusBanner" class="banner"></div>

    <section>
        <h3 class="section-title">üìã Ingredients</h3>
        <details class="ingredients-dropdown">
            <summary>List of Ingredients</summary>
            <div id="ingredientList"></div>
        </details>
    </section>

    <section>
        <h3 class="section-title">‚ö†Ô∏è Risky Ingredients</h3>
        <div class="risk-grid" id="riskGrid"></div>

         <div id="aiSummary"
         style="white-space:pre-line;
                background:white;
                padding:1.5rem;
                border-radius:14px;
                border:1px solid #e2e8f0;
                margin-top:1.5rem;">
    </div>
    </section>

</div>

</main>
</div>

<script>
const dropZone=document.getElementById('dropZone');
const fileInput=document.getElementById('fileInput');
const analyzeBtn=document.getElementById('analyzeBtn');
const loader=document.getElementById('loader');
const results=document.getElementById('results');
const emptyState=document.getElementById('emptyState');

let currentFile=null;

dropZone.onclick=()=>fileInput.click();

fileInput.onchange=e=>{
    if(e.target.files.length){
        currentFile=e.target.files[0];
        dropZone.textContent="‚úÖ Image Selected";
    }
};

analyzeBtn.onclick=async()=>{
    if(!currentFile) return alert("Upload image first");

    const allergies=document.getElementById('allergyInput')
        .value.split(',')
        .map(s=>s.trim().toLowerCase())
        .filter(Boolean);

    const formData=new FormData();
    formData.append('file',currentFile);
    formData.append('allergies',JSON.stringify(allergies));

    loader.style.display='flex';
    analyzeBtn.disabled=true;

    try{
        const res=await fetch('/analyze-label',{method:'POST',body:formData});
        const data=await res.json();
        render(data);
    }catch(e){
        alert("Error");
    }finally{
        loader.style.display='none';
        analyzeBtn.disabled=false;
    }
};

function render(data){
    emptyState.style.display='none';
    results.classList.add('active');

    const risks=data.analysis?.risky_ingredients||[];

    const banner=document.getElementById('statusBanner');
    banner.className="banner "+(risks.length?"danger":"safe");
    banner.innerHTML=risks.length
        ?`üö® ‡∏û‡∏ö‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ ${risks.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
        :`‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ`;

    document.getElementById('ingredientList').innerHTML=
        data.ingredients.map(i=>`<span class="tag">${i.corrected||i.original}</span>`).join('');

    document.getElementById('riskGrid').innerHTML=
        risks.map(r=>`<div class="risk-card">${r.name}</div>`).join('');

    // üëá ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    document.getElementById('aiSummary').innerText =
        data.analysis?.summary || '';
}
</script>

</body>
</html>
