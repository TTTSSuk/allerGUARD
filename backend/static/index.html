<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>AllerGUARD ‚Äì AI Label Checker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
        }
        label {
            font-weight: bold;
            display: block;
            margin-top: 15px;
        }
        input, textarea, button {
            width: 100%;
            margin-top: 8px;
            margin-bottom: 16px;
            padding: 10px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            white-space: pre-wrap;
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.info {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background-color: #e8f5e9;
            color: #388e3c;
        }
        .status.error {
            background-color: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>

<h1>AllerGUARD üß™</h1>
<p>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏â‡∏•‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏£‡πÉ‡∏î‡∏≠‡∏≤‡∏à‡∏Å‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ</p>

<label>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏â‡∏•‡∏≤‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
<input type="file" id="imageInput" accept="image/*">

<label>‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ (‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢ ,)</label>
<input type="text" id="allergiesInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô salicylate, fragrance">

<button id="analyzeBtn" onclick="analyze()">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏â‡∏•‡∏≤‡∏Å</button>

<div id="statusBox"></div>

<h2>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h2>
<pre id="result">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</pre>

<!-- <script>
function showStatus(message, type = 'info') {
    const statusBox = document.getElementById('statusBox');
    statusBox.innerHTML = `<div class="status ${type}">${message}</div>`;
    console.log(`[${type.toUpperCase()}] ${message}`);
}

async function analyze() {
    console.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô analyze()');
    
    const fileInput = document.getElementById("imageInput");
    const allergiesInput = document.getElementById("allergiesInput");
    const resultBox = document.getElementById("result");
    const analyzeBtn = document.getElementById("analyzeBtn");

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    if (!fileInput.files.length) {
        console.error('‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå');
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
        return;
    }

    console.log('üìÅ ‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:', fileInput.files[0].name);

    // ‡πÅ‡∏õ‡∏•‡∏á allergies ‡πÄ‡∏õ‡πá‡∏ô array
    const allergies = allergiesInput.value
        .split(",")
        .map(a => a.trim())
        .filter(a => a.length > 0);

    console.log('üî¥ ‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ:', allergies);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á FormData
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    formData.append("allergies", JSON.stringify(allergies));

    console.log('üì¶ FormData ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á');

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î
    analyzeBtn.disabled = true;
    resultBox.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢ AI ...";
    showStatus("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á AI...", "info");

    try {
        console.log('üåê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á POST request ‡πÑ‡∏õ‡∏ó‡∏µ‡πà /analyze-label');
        
        const response = await fetch("/analyze-label", {
            method: "POST",
            body: formData
        });

        console.log('üì® ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö response:', response.status, response.statusText);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('‚úÖ ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON:', data);

        resultBox.textContent = JSON.stringify(data, null, 2);
        showStatus("‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!", "success");

    } catch (error) {
        console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error);
        resultBox.textContent = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
        showStatus("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message, "error");
    } finally {
        analyzeBtn.disabled = false;
        console.log('üèÅ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô analyze()');
    }
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
window.onload = function() {
    console.log('‚úÖ ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    showStatus("‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", "success");
}
</script> -->
<script>
async function analyze() {
    const fileInput = document.getElementById("imageInput");
    const allergiesInput = document.getElementById("allergiesInput");

    const ingredientList = document.getElementById("ingredientList");
    const analysisResult = document.getElementById("analysisResult");

    ingredientList.innerHTML = "";
    analysisResult.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏î‡πâ‡∏ß‡∏¢ AI ...";

    if (!fileInput.files.length) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
        return;
    }

    const allergies = allergiesInput.value
        .split(",")
        .map(a => a.trim().toLowerCase())
        .filter(a => a.length > 0);

    const formData = new FormData();
    formData.append("file", fileInput.files[0]);
    formData.append("allergies", JSON.stringify(allergies));

    try {
        const response = await fetch("/analyze-label", {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        // ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ ingredient
        if (data.error) {
            analysisResult.innerHTML = `<p style="color:red;">‚ùå ${data.error}</p>`;
            return;
        }

        // 1Ô∏è‚É£ ‡πÅ‡∏™‡∏î‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°
        data.ingredients.forEach(item => {
            const li = document.createElement("li");
            li.textContent = item.corrected;
            ingredientList.appendChild(li);
        });

        // 2Ô∏è‚É£ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ
        const risky = data.analysis.risky_ingredients;

        if (!risky || risky.length === 0) {
            analysisResult.innerHTML = `
                <p style="color:green; font-weight:bold;">
                ‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ‡πÉ‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ô‡∏µ‡πâ
                </p>
            `;
        } else {
            let html = `
                <p style="color:red; font-weight:bold;">
                ‚ùå ‡∏û‡∏ö‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ‡πÉ‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ô‡∏µ‡πâ
                </p>
                <ul>
            `;

            risky.forEach(r => {
                html += `
                    <li>
                        <b>${r.name}</b> (Risk: ${r.risk_level})<br>
                        ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ${r.reason}
                    </li>
                `;
            });

            html += `
                </ul>
                <p><b>‡∏™‡∏£‡∏∏‡∏õ:</b> ${data.analysis.summary}</p>
            `;

            analysisResult.innerHTML = html;
        }

    } catch (err) {
        analysisResult.innerHTML =
            `<p style="color:red;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err}</p>`;
    }
}
</script>

</body>
</html>