import subprocess
import re

def analyze_with_ai(normalized_ingredients, user_allergies, detected_allergens):
    """‡πÉ‡∏´‡πâ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô: ‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ + ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£ + ‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å + ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"""
    
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
    allergen_details = []
    for a in detected_allergens:
        ing_name = a['ingredient']
        # ‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£
        try:
            position = normalized_ingredients.index(ing_name) + 1
            total = len(normalized_ingredients)
            allergen_details.append(f"- {ing_name} (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà {position}/{total})")
        except ValueError:
            allergen_details.append(f"- {ing_name}")
    
    allergen_list = "\n".join(allergen_details)
    
    # ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ)
    all_ingredients = "\n".join([f"{i+1}. {ing}" for i, ing in enumerate(normalized_ingredients)])
    
    prompt = f"""‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ

üìã ‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô ‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢):
{all_ingredients}

‚ö†Ô∏è ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏û‡πâ‡∏™‡∏≤‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ: {", ".join(user_allergies)}

üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏™‡∏≤‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå:
{allergen_list}

‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:

1. ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö:
   - ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏û‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
   - ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏™‡∏π‡∏ï‡∏£ (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡πâ‡∏ô = ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡∏™‡∏π‡∏á = ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏°‡∏≤‡∏Å)
   - ‡∏ö‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô

2. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ (Cross-reactivity):
   - ‚ö†Ô∏è ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏£‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏û‡πâ
   - ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:
     * ‡πÅ‡∏û‡πâ Salicylic Acid ‚Üí ‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ‡∏Å‡∏±‡∏ö Willow Bark Extract, Wintergreen Oil (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏°‡∏µ salicylates)
     * ‡πÅ‡∏û‡πâ Parabens ‚Üí ‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ‡∏Å‡∏±‡∏ö Methylparaben, Propylparaben (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏£‡∏∞‡∏Å‡∏π‡∏•‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
     * ‡πÅ‡∏û‡πâ Curcuma ‚Üí ‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ‡∏Å‡∏±‡∏ö Turmeric Extract (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏∑‡∏ä‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
   - ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏∏‡πà‡∏°‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô ‡πÄ‡∏ä‡πà‡∏ô Madecassoside ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Salicylic Acid ‡πÄ‡∏•‡∏¢!
   - ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ"

3. ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:
   - ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏±‡∏ô‡πÅ‡∏ï‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Å‡∏ß‡πà‡∏≤
   - ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á

4. ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ:
   - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ ‚Üí ‡∏ï‡∏≠‡∏ö "‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ"
   - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥ ‚Üí ‡∏ï‡∏≠‡∏ö "‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ß‡∏±‡∏á"
   - ‡∏ñ‡πâ‡∏≤‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‚Üí ‡∏ï‡∏≠‡∏ö "‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ"

‡∏Å‡∏é‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
- ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏±‡∏î‡πÅ‡∏¢‡πâ‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á (‡∏≠‡∏¢‡πà‡∏≤‡∏ö‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á "‡∏°‡∏µ‡∏™‡∏≤‡∏£‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ" ‡πÅ‡∏•‡∏∞ "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏£‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ" ‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
- ‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

‡∏ï‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:

1Ô∏è‚É£ ‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á:
üî¥ [‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£] (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á X/Y)
‚Üí ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô: [‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å/‡∏™‡∏π‡∏á/‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡∏ï‡πà‡∏≥/‡∏ï‡πà‡∏≥‡∏°‡∏≤‡∏Å]
‚Üí ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î: [‡∏≠‡∏≤‡∏Å‡∏≤‡∏£]
‚Üí ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: [‡∏™‡∏π‡∏á‡∏°‡∏≤‡∏Å/‡∏™‡∏π‡∏á/‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡∏ï‡πà‡∏≥]

[‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏£ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î]

2Ô∏è‚É£ ‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ:
[‡∏ñ‡πâ‡∏≤‡∏°‡∏µ:]
üü° [‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£] (‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á X/Y)
‚Üí ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: [‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡∏ñ‡∏∂‡∏á‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ‡πÑ‡∏î‡πâ]
‚Üí ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: [‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡∏ï‡πà‡∏≥]

[‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ:]
‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ‡πÉ‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏ô‡∏µ‡πâ

3Ô∏è‚É£ ‡∏™‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
‚úÖ [‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ 1] - [‡∏§‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏î‡∏µ]
‚úÖ [‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ 2] - [‡∏§‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏î‡∏µ]

4Ô∏è‚É£ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
[‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ/‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ß‡∏±‡∏á/‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ] - [‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•]

5Ô∏è‚É£ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ:
1. [‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1]
2. [‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2]
3. [‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3]
"""

    print("‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 60-120 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)...")
    
    try:
        result = subprocess.run(
            [
                "ollama",
                "run",
                "scb10x/llama3.1-typhoon2-8b-instruct"
            ],
            input=prompt,
            text=True,
            capture_output=True,
            encoding="utf-8",
            timeout=1800
        )
        
        print("‚úÖ AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!")
        return result.stdout
        
    except subprocess.TimeoutExpired:
        print("‚ùå AI ‡∏ï‡∏≠‡∏ö‡∏ä‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (timeout)")
        return """
1Ô∏è‚É£ ‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á:
üî¥ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ
‚Üí ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô: ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö
‚Üí ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î: ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö
‚Üí ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á: ‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö

2Ô∏è‚É£ ‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ:
‚ùå AI timeout - ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ

3Ô∏è‚É£ ‡∏™‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ

4Ô∏è‚É£ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á

5Ô∏è‚É£ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ:
1. ‡∏ó‡∏≤‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏û‡∏±‡∏ö‡πÅ‡∏Ç‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô
2. ‡∏£‡∏≠ 24-48 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
3. ‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
"""
    except Exception as e:
        print(f"‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: {e}")
        return f"""
1Ô∏è‚É£ ‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏û‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á:
üî¥ Error: {str(e)}

2Ô∏è‚É£ ‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏û‡πâ‡πÑ‡∏Ç‡∏ß‡πâ:
‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î

3Ô∏è‚É£ ‡∏™‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ

4Ô∏è‚É£ ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:
‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö

5Ô∏è‚É£ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ:
1. ‡∏ó‡∏≤‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏Ç‡πâ‡∏≠‡∏û‡∏±‡∏ö‡πÅ‡∏Ç‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô
2. ‡∏£‡∏≠ 24-48 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
3. ‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
"""


def process_with_ai(normalized_ingredients, user_allergies, detected_allergens):
    """‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà pipeline ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ"""
    
    if not user_allergies or not detected_allergens:
        return {
            "status": "success",
            "raw_ai_output": ""
        }
    
    print("ü§ñ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡∏î‡πâ‡∏ß‡∏¢ AI...")
    ai_output = analyze_with_ai(normalized_ingredients, user_allergies, detected_allergens)
    
    return {
        "status": "success",
        "raw_ai_output": ai_output
    }